<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Management - Brutally Honest</title>
    
    <link rel="icon" type="image/svg+xml" href="logo.svg">
    <!-- Design System (load first) -->
    <link rel="stylesheet" href="design-system.css">
    <!-- Application Styles -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="dynamic-portal.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="navigation.js"></script>
    <script src="dynamic-portal.js"></script>
    <script src="notifications.js"></script>
</head>
<body>
    <div class="container">
        <!-- Navigation injected by navigation.js -->
        <div id="navigation-placeholder"></div>

        <!-- Main Content -->
        <div class="main-content">

            <!-- Profile Type Selection -->
            <div class="section">
                <div class="flex gap-3 justify-center mb-5">
                    <button class="icon-tab active" onclick="switchProfileType('clients')" id="tab-clients" title="Clients">
                        <i data-lucide="briefcase"></i>
                    </button>
                    <button class="icon-tab" onclick="switchProfileType('brands')" id="tab-brands" title="Brands">
                        <i data-lucide="tag"></i>
                    </button>
                    <button class="icon-tab" onclick="switchProfileType('persons')" id="tab-persons" title="Persons">
                        <i data-lucide="user"></i>
                    </button>
                </div>
            </div>

            <!-- Create Profile Section -->
            <div class="section">
                <h2 id="create-profile-title">Create Client Profile</h2>
                <form id="create-profile-form" onsubmit="createProfile(event)">
                    <div class="flex flex-col gap-4">
                        <div class="form-group">
                            <label class="form-label">Name *</label>
                            <input type="text" id="profile-name" required class="form-input">
                        </div>
                        
                        <div id="person-fields" class="form-group hidden">
                            <label class="form-label">Role</label>
                            <input type="text" id="profile-role" class="form-input">
                        </div>
                        
                        <div id="person-company-field" class="form-group hidden">
                            <label class="form-label">Company</label>
                            <input type="text" id="profile-company" class="form-input">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Description *</label>
                            <textarea id="profile-description" required rows="3" class="form-input"></textarea>
                        </div>
                        
                        <div id="brand-values-field" class="form-group hidden">
                            <label class="form-label">Values (comma-separated)</label>
                            <input type="text" id="profile-values" placeholder="e.g., quality, innovation, sustainability" class="form-input">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Tags (comma-separated)</label>
                            <input type="text" id="profile-tags" placeholder="e.g., retail, DIY, europe" class="form-input">
                        </div>
                        
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary btn-block">
                                <i data-lucide="plus"></i>
                                Create Profile
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Profiles List -->
            <div class="section">
                <h2 id="profiles-list-title">Client Profiles</h2>
                <div id="profiles-list" class="flex flex-col gap-4">
                    <div class="empty-state">
                        <i data-lucide="users" style="width: 48px; height: 48px; margin-bottom: var(--space-4);"></i>
                        <p>No profiles yet. Create your first profile above.</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentProfileType = 'clients';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadProfiles();
        });

        function switchProfileType(type) {
            currentProfileType = type;
            
            // Update tabs
            document.querySelectorAll('.icon-tab').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${type}`).classList.add('active');
            
            // Update form fields
            const personFields = document.getElementById('person-fields');
            const personCompanyField = document.getElementById('person-company-field');
            const brandValuesField = document.getElementById('brand-values-field');
            
            personFields.classList.add('hidden');
            personCompanyField.classList.add('hidden');
            brandValuesField.classList.add('hidden');
            
            if (type === 'clients') {
                document.getElementById('create-profile-title').textContent = 'Create Client Profile';
                document.getElementById('profiles-list-title').textContent = 'Client Profiles';
            } else if (type === 'brands') {
                brandValuesField.classList.remove('hidden');
                document.getElementById('create-profile-title').textContent = 'Create Brand Profile';
                document.getElementById('profiles-list-title').textContent = 'Brand Profiles';
            } else if (type === 'persons') {
                personFields.classList.remove('hidden');
                personCompanyField.classList.remove('hidden');
                document.getElementById('create-profile-title').textContent = 'Create Person Profile';
                document.getElementById('profiles-list-title').textContent = 'Person Profiles';
            }
            
            // Load profiles
            loadProfiles();
            
            // Reset form
            document.getElementById('create-profile-form').reset();
        }

        async function createProfile(event) {
            event.preventDefault();
            
            try {
                const name = document.getElementById('profile-name').value;
                const description = document.getElementById('profile-description').value;
                const tags = document.getElementById('profile-tags').value;
                
                let formData = new URLSearchParams();
                formData.append('name', name);
                formData.append('description', description);
                if (tags) formData.append('tags', tags);
                
                let endpoint = '';
                if (currentProfileType === 'clients') {
                    endpoint = '/profiles/clients';
                } else if (currentProfileType === 'brands') {
                    const values = document.getElementById('profile-values').value;
                    if (values) formData.append('values', values);
                    endpoint = '/profiles/brands';
                } else if (currentProfileType === 'persons') {
                    const role = document.getElementById('profile-role').value;
                    const company = document.getElementById('profile-company').value;
                    if (role) formData.append('role', role);
                    if (company) formData.append('company', company);
                    endpoint = '/profiles/persons';
                }
                
                const response = await fetch(`${API_BASE}${endpoint}?${formData.toString()}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('[OK] Profile created successfully!', 'success');
                    document.getElementById('create-profile-form').reset();
                    loadProfiles();
                } else {
                    showNotification('[ERROR] Failed to create profile', 'error');
                }
            } catch (error) {
                console.error('Error creating profile:', error);
                showNotification('[ERROR] Error creating profile', 'error');
            }
        }

        async function loadProfiles() {
            try {
                let endpoint = '';
                if (currentProfileType === 'clients') {
                    endpoint = '/profiles/clients';
                } else if (currentProfileType === 'brands') {
                    endpoint = '/profiles/brands';
                } else if (currentProfileType === 'persons') {
                    endpoint = '/profiles/persons';
                }
                
                const response = await fetch(`${API_BASE}${endpoint}`);
                const result = await response.json();
                
                const listEl = document.getElementById('profiles-list');
                
                if (result.success && result.profiles && result.profiles.length > 0) {
                    listEl.innerHTML = result.profiles.map(profile => `
                        <div class="card">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="text-primary font-semibold mb-1">${escapeHtml(profile.name)}</h3>
                                    ${profile.type ? `<span class="badge badge-neutral">${escapeHtml(profile.type)}</span>` : ''}
                                    ${profile.role ? `<span class="badge badge-neutral">${escapeHtml(profile.role)}</span>` : ''}
                                </div>
                                <button onclick="deleteProfile('${profile.id}')" class="btn btn-danger btn-sm">
                                    <i data-lucide="trash-2"></i>
                                </button>
                            </div>
                            <p class="text-tertiary mb-3">${escapeHtml(profile.description)}</p>
                            ${profile.tags && profile.tags.length > 0 ? `
                                <div class="flex flex-wrap gap-2 mb-3">
                                    ${profile.tags.map(tag => `<span class="badge badge-info">${escapeHtml(tag)}</span>`).join('')}
                                </div>
                            ` : ''}
                            <div class="flex justify-between items-center pt-4 border-t">
                                <span class="text-sm text-tertiary">${profile.facts ? profile.facts.length : 0} facts</span>
                                <button onclick="viewProfile('${profile.id}')" class="btn btn-primary btn-sm">
                                    View Details
                                </button>
                            </div>
                        </div>
                    `).join('');
                    
                    lucide.createIcons();
                } else {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <i data-lucide="users" style="width: 48px; height: 48px; margin-bottom: var(--space-4);"></i>
                            <p>No profiles yet. Create your first profile above.</p>
                        </div>
                    `;
                    lucide.createIcons();
                }
            } catch (error) {
                console.error('Error loading profiles:', error);
            }
        }

        async function deleteProfile(profileId) {
            if (!confirm('Are you sure you want to delete this profile?')) return;
            
            try {
                let endpoint = '';
                if (currentProfileType === 'clients') {
                    endpoint = `/profiles/clients/${profileId}`;
                } else if (currentProfileType === 'brands') {
                    endpoint = `/profiles/brands/${profileId}`;
                } else if (currentProfileType === 'persons') {
                    endpoint = `/profiles/persons/${profileId}`;
                }
                
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('[OK] Profile deleted successfully', 'success');
                    loadProfiles();
                } else {
                    showNotification('[ERROR] Failed to delete profile', 'error');
                }
            } catch (error) {
                console.error('Error deleting profile:', error);
                showNotification('[ERROR] Error deleting profile', 'error');
            }
        }

        function viewProfile(profileId) {
            alert(`Profile details view coming soon! ID: ${profileId}`);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message, type) {
            if (typeof Notifications !== 'undefined') {
                Notifications.show(message, type);
            } else {
                alert(message);
            }
        }
        
        // Info Modal - How Profiles Work
        function showPageInfo() {
            const modal = document.createElement('div');
            modal.className = 'info-modal';
            modal.innerHTML = `
                <div class="info-modal-content">
                    <button class="info-modal-close" onclick="this.closest('.info-modal').remove()">&times;</button>
                    <h2>ðŸ‘¥ Profile Management</h2>
                    
                    <h3>Profile Types</h3>
                    <ul>
                        <li><strong>Clients</strong> - Business clients with contact information</li>
                        <li><strong>Brands</strong> - Company brands with guidelines and documents</li>
                        <li><strong>Persons</strong> - Individual speakers for voice recognition</li>
                    </ul>
                    
                    <h3>Voice Profiles</h3>
                    <p>Create person profiles with voice samples to enable speaker identification in transcriptions. The system learns to recognize different voices over time.</p>
                    
                    <h3>Brand Documents</h3>
                    <p>Attach documents to brand profiles to validate claims against official brand guidelines, policies, and marketing materials.</p>
                    
                    <p class="info-tip">
                        <strong>Tip:</strong> Link person profiles to client or brand profiles for comprehensive tracking and analysis.
                    </p>
                </div>
            `;
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        // User Menu
        function toggleUserMenu() {
            document.getElementById('user-dropdown').classList.toggle('show');
        }
        
        async function logout() {
            try { await fetch('/api/auth/logout', { method: 'POST' }); } catch (e) {}
            window.location.href = '/login';
        }
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-menu')) {
                const dropdown = document.getElementById('user-dropdown');
                if (dropdown) dropdown.classList.remove('show');
            }
        });
        
        fetch('/api/auth/status').then(r => r.json()).then(data => {
            if (data.authenticated && data.user) {
                document.getElementById('current-user').textContent = data.user.name || 'Account';
                document.getElementById('user-email').textContent = data.user.email;
            }
        }).catch(() => {});
    </script>

    <style>
        .icon-tab {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border: none;
            background: var(--accent-primary);
            color: var(--text-inverse);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition-normal);
        }
        
        .icon-tab i {
            width: 22px;
            height: 22px;
        }
        
        .icon-tab:hover {
            background: var(--accent-secondary);
            transform: scale(1.05);
        }
        
        .icon-tab.active {
            background: var(--accent-primary);
            box-shadow: var(--shadow-md);
        }
        
        .border-t {
            border-top: 1px solid var(--border-primary);
        }
    </style>
    
    <footer class="site-footer">
        <div class="footer-content">
            <a href="https://altfawesome.com" target="_blank" class="footer-link">altfawesome.com</a>
            <span class="footer-divider">Â·</span>
            <span>Â© 2025</span>
        </div>
    </footer>
</body>
</html>
