<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brutal Honest AI</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Brutal Honest AI</h1>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot" id="backend-status"></div>
                    <span>Backend</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="llm-status"></div>
                    <span>LLM</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="audio-status"></div>
                    <span>Audio</span>
                </div>
            </div>
            
            <!-- Connection Info Panel -->
            <div class="connection-info" id="connection-info" style="display: none;">
                <div class="connection-item">
                    <i data-lucide="bluetooth" class="connection-icon"></i>
                    <span class="connection-label">Connection:</span>
                    <span class="connection-value" id="connection-type">Bluetooth</span>
                </div>
                <div class="connection-item">
                    <i data-lucide="battery" class="connection-icon"></i>
                    <span class="connection-label">Battery:</span>
                    <span class="battery-text" id="battery-text">100%</span>
                </div>
                <div class="connection-item">
                    <i data-lucide="signal" class="connection-icon"></i>
                    <span class="connection-label">Signal:</span>
                    <span class="signal-text" id="signal-text">Strong</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Live Recording Section -->
            <div class="section">
                <h2>Live Recording</h2>
                
                <!-- Recording Controls -->
                <div class="recording-controls">
                    <button id="start-record-btn" class="btn btn-primary" onclick="startRecording()">
                        Start Recording
                    </button>
                    <button id="stop-record-btn" class="btn btn-secondary" onclick="stopRecording()" disabled>
                        Stop Recording
                    </button>
                    <button id="toggle-log-btn" class="btn btn-secondary" onclick="toggleSystemLog()">
                        Enable System Log
                    </button>
                </div>

                <!-- Recording Status -->
                <div class="recording-status" id="recording-status">
                    <div class="recording-indicator" id="recording-indicator">‚óè</div>
                    <span>Ready to record</span>
                </div>

                <!-- Results Display -->
                <div class="results-container" id="results-container" style="display: none;">
                    <!-- Transcript -->
                    <div class="result-section">
                        <h3>Transcript</h3>
                        <div class="transcript-text" id="transcript-text">
                            Your transcribed speech will appear here...
                        </div>
                    </div>

                    <!-- Analysis -->
                    <div class="result-section">
                        <h3>BRUTAL HONESTY ANALYSIS</h3>
                        <div class="analysis-text robot-analysis" id="analysis-text">
                            <div class="robot-header">
                                <span class="robot-indicator">[ANALYZING...]</span>
                                <span class="robot-status">SYSTEM READY</span>
                            </div>
                            <div class="robot-content">
                                Analysis will appear here...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Demo Log -->
            <div class="section" id="system-log-section" style="display: none;">
                <h2>System Log</h2>
                <div class="demo-log" id="demo-log">
                    System log will appear here...
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let isRecording = false;
        let systemLogEnabled = false;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Lucide icons
            lucide.createIcons();
            
            checkBackendStatus();
            connectWebSocket();
            
            // Update connection info every 5 seconds
            setInterval(updateDetailedConnectionInfo, 5000);
        });

        async function checkBackendStatus() {
            try {
                const response = await fetch('/api/status');
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update Backend status
                    const backendStatus = document.getElementById('backend-status');
                    backendStatus.classList.remove('online', 'offline');
                    backendStatus.classList.add('online');
                    
                    // Update LLM status based on actual data
                    const llmStatus = document.getElementById('llm-status');
                    llmStatus.classList.remove('online', 'offline');
                    if (data.llm_analyzer && data.services && data.services.ollama) {
                        llmStatus.classList.add('online');
                    } else {
                        llmStatus.classList.add('offline');
                    }
                    
                    // Update Audio status based on actual data
                    const audioStatus = document.getElementById('audio-status');
                    audioStatus.classList.remove('online', 'offline');
                    if (data.audio_processor && data.omi_connected) {
                        audioStatus.classList.add('online');
                        
                        // Show connection info if OMI is connected
                        updateConnectionInfo(data);
                    } else {
                        audioStatus.classList.add('offline');
                        hideConnectionInfo();
                    }
                } else {
                    // All offline if backend is not responding
                    document.getElementById('backend-status').classList.add('offline');
                    document.getElementById('llm-status').classList.add('offline');
                    document.getElementById('audio-status').classList.add('offline');
                    hideConnectionInfo();
                }
            } catch (error) {
                // All offline if there's an error
                document.getElementById('backend-status').classList.add('offline');
                document.getElementById('llm-status').classList.add('offline');
                document.getElementById('audio-status').classList.add('offline');
                hideConnectionInfo();
                addDemoLog('[ERROR] Backend connection failed');
            }
        }
        
        function updateConnectionInfo(data) {
            const connectionInfo = document.getElementById('connection-info');
            
            // Show connection info panel
            connectionInfo.style.display = 'flex';
            
            // Update connection type and icon
            const connectionType = document.getElementById('connection-type');
            const connectionIcon = document.querySelector('.connection-item i[data-lucide]');
            
            if (data.connection_type === 'bluetooth' || (data.omi_device && data.omi_device.includes('BLE'))) {
                connectionType.textContent = 'Bluetooth';
                connectionIcon.setAttribute('data-lucide', 'bluetooth');
            } else if (data.connection_type === 'usb' || data.omi_device) {
                connectionType.textContent = 'USB';
                connectionIcon.setAttribute('data-lucide', 'usb');
            } else {
                connectionType.textContent = 'Unknown';
                connectionIcon.setAttribute('data-lucide', 'help-circle');
            }
            
            // Refresh icons after changing attributes
            lucide.createIcons();
            
            // Update battery level (simulate if not available)
            let batteryLevel = 100;
            if (data.battery_level !== undefined) {
                batteryLevel = data.battery_level;
            } else {
                // Simulate battery level based on connection type
                batteryLevel = data.omi_device && data.omi_device.includes('bluetooth') ? 85 : 100;
            }
            
            updateBatteryIndicator(batteryLevel);
            
            // Update signal strength (simulate based on connection)
            let signalStrength = 4; // Strong signal
            if (data.signal_strength !== undefined) {
                signalStrength = data.signal_strength;
            } else {
                // Simulate signal strength
                if (data.omi_device && data.omi_device.includes('bluetooth')) {
                    signalStrength = Math.floor(Math.random() * 2) + 3; // 3-4 bars for Bluetooth
                } else {
                    signalStrength = 4; // Full signal for USB
                }
            }
            
            updateSignalIndicator(signalStrength);
        }
        
        function hideConnectionInfo() {
            const connectionInfo = document.getElementById('connection-info');
            connectionInfo.style.display = 'none';
        }
        
        function updateBatteryIndicator(level) {
            const batteryLevelEl = document.getElementById('battery-level');
            const batteryTextEl = document.getElementById('battery-text');
            
            // Update width
            batteryLevelEl.style.width = level + '%';
            batteryTextEl.textContent = level + '%';
            
            // Update color based on level
            batteryLevelEl.classList.remove('low', 'medium');
            if (level <= 20) {
                batteryLevelEl.classList.add('low');
            } else if (level <= 50) {
                batteryLevelEl.classList.add('medium');
            }
        }
        
        function updateSignalIndicator(strength) {
            const signalTextEl = document.getElementById('signal-text');
            
            // Update signal bars
            for (let i = 1; i <= 4; i++) {
                const bar = document.getElementById(`signal-bar-${i}`);
                if (i <= strength) {
                    bar.classList.add('active');
                } else {
                    bar.classList.remove('active');
                }
            }
            
            // Update signal text
            const signalTexts = ['None', 'Weak', 'Fair', 'Good', 'Strong'];
            signalTextEl.textContent = signalTexts[strength] || 'Unknown';
        }
        
        async function updateDetailedConnectionInfo() {
            try {
                const response = await fetch('/api/connection/info');
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.connected) {
                        // Update connection type and icon
                        const connectionType = document.getElementById('connection-type');
                        const connectionIcon = document.querySelector('.connection-item i[data-lucide]');
                        
                        if (data.connection_type === 'bluetooth') {
                            connectionType.textContent = 'Bluetooth';
                            connectionIcon.setAttribute('data-lucide', 'bluetooth');
                        } else {
                            connectionType.textContent = 'USB';
                            connectionIcon.setAttribute('data-lucide', 'usb');
                        }
                        
                        // Refresh icons
                        lucide.createIcons();
                        
                        // Update battery level with real data
                        updateBatteryIndicator(data.battery_level || 100);
                        
                        // Update signal strength with real data
                        updateSignalIndicator(data.signal_strength || 4);
                        
                        // Show connection info if not already visible
                        const connectionInfo = document.getElementById('connection-info');
                        if (connectionInfo.style.display === 'none') {
                            connectionInfo.style.display = 'flex';
                        }
                    }
                }
            } catch (error) {
                // Silently fail - connection info will be hidden by main status check
                console.log('Connection info update failed:', error);
            }
        }

        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:8000/api/audio/stream');
            
            ws.onopen = () => {
                console.log('Connected to server');
                addDemoLog('[SYSTEM] Connected to Voice Insight Platform');
            };
            
            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                console.log('Received:', message);
                
                switch(message.type) {
                    case 'connection':
                        addDemoLog('[CONNECT] ' + message.data);
                        break;
                        
                    case 'info':
                        addDemoLog('[INFO] ' + message.data.message);
                        break;
                        
                    case 'recording_start':
                        updateRecordingStatus(message.data.message, true);
                        addDemoLog('[RECORD] ' + message.data.message);
                        updateRobotStatus('RECORDING');
                        break;
                        
                    case 'recording_stop':
                        updateRecordingStatus(message.data.message, false);
                        addDemoLog('[STOP] ' + message.data.message);
                        updateRobotStatus('PROCESSING');
                        break;
                        
                    case 'transcript':
                        showTranscript(message.data);
                        break;
                        
                    case 'analysis':
                        showAnalysis(message.data.brutal_response);
                        updateRobotStatus('ANALYSIS COMPLETE');
                        break;
                        
                    case 'error':
                        addDemoLog('[ERROR] ' + message.data.message);
                        updateRobotStatus('ERROR');
                        resetRecordingButtons();
                        break;
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                addDemoLog('[ERROR] Connection error');
            };
            
            ws.onclose = () => {
                console.log('Disconnected from server');
                addDemoLog('[DISCONNECT] Connection lost - attempting reconnect...');
                setTimeout(connectWebSocket, 3000);
            };
        }

        function startRecording() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addDemoLog('[ERROR] Not connected to server');
                return;
            }
            
            isRecording = true;
            document.getElementById('start-record-btn').disabled = true;
            document.getElementById('stop-record-btn').disabled = false;
            
            // Hide previous results
            document.getElementById('results-container').style.display = 'none';
            updateRobotStatus('INITIALIZING');
            
            ws.send(JSON.stringify({ action: 'start_recording' }));
        }

        function stopRecording() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addDemoLog('[ERROR] Not connected to server');
                return;
            }
            
            isRecording = false;
            document.getElementById('start-record-btn').disabled = false;
            document.getElementById('stop-record-btn').disabled = true;
            
            ws.send(JSON.stringify({ action: 'stop_recording' }));
        }

        function resetRecordingButtons() {
            isRecording = false;
            document.getElementById('start-record-btn').disabled = false;
            document.getElementById('stop-record-btn').disabled = true;
            updateRecordingStatus('Ready to record', false);
        }

        function updateRecordingStatus(message, recording) {
            const statusElement = document.querySelector('#recording-status span');
            const indicator = document.getElementById('recording-indicator');
            
            statusElement.textContent = message;
            
            if (recording) {
                indicator.style.color = '#ef4444';
                indicator.classList.add('pulse');
            } else {
                indicator.style.color = '#cccccc';
                indicator.classList.remove('pulse');
            }
        }

        function showTranscript(text) {
            document.getElementById('results-container').style.display = 'block';
            document.getElementById('transcript-text').textContent = text;
        }

        function showAnalysis(text) {
            const robotContent = document.querySelector('.robot-content');
            robotContent.textContent = text;
        }

        function updateRobotStatus(status) {
            const robotStatus = document.querySelector('.robot-status');
            const robotIndicator = document.querySelector('.robot-indicator');
            
            robotStatus.textContent = status;
            
            switch(status) {
                case 'RECORDING':
                    robotIndicator.textContent = '[RECORDING...]';
                    robotIndicator.className = 'robot-indicator recording';
                    break;
                case 'PROCESSING':
                    robotIndicator.textContent = '[PROCESSING...]';
                    robotIndicator.className = 'robot-indicator processing';
                    break;
                case 'ANALYSIS COMPLETE':
                    robotIndicator.textContent = '[COMPLETE]';
                    robotIndicator.className = 'robot-indicator complete';
                    break;
                case 'ERROR':
                    robotIndicator.textContent = '[ERROR]';
                    robotIndicator.className = 'robot-indicator error';
                    break;
                default:
                    robotIndicator.textContent = '[READY]';
                    robotIndicator.className = 'robot-indicator ready';
            }
        }

        function toggleSystemLog() {
            const logSection = document.getElementById('system-log-section');
            const toggleBtn = document.getElementById('toggle-log-btn');
            
            systemLogEnabled = !systemLogEnabled;
            
            if (systemLogEnabled) {
                logSection.style.display = 'block';
                toggleBtn.textContent = 'Disable System Log';
                addDemoLog('[SYSTEM] System log enabled');
            } else {
                logSection.style.display = 'none';
                toggleBtn.textContent = 'Enable System Log';
            }
        }

        function addDemoLog(message) {
            if (!systemLogEnabled) return;
            
            const logElement = document.getElementById('demo-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }
    </script>
</body>
</html>